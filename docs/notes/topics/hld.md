# 树链剖分
## 两种剖分方式
在此不再赘述重链剖分和长链剖分的定义，简单来说，重链剖分依照的是子树大小，而长链剖分依照的是子树深度。

**共同**的性质有：

> 所有链长度的和是 $O(n)$ 级别的。

证明：由于所有的点在且仅在一条重链中，可以证明，链长的总和等于节点的总数，也就是 $O(n)$ 级别。

**重链剖分**的性质有：

>  根到任意节点轻边的个数**小于** $\log{n}$。

证明：设节点 $u$ 的父节点为 $u'$，若连接该两点的边为轻边，则 $siz_{u'} \geq siz_{u} \times 2 + 1 > siz_{u} \times 2$，若为重边，则 $siz_{u'} \geq siz_{u} + 1 > siz_{u}$。若该节点到根节点的路径上有 $k$ 条轻边，则树的大小满足关系 $n = siz_{root} > 2^k \times siz_{u} \geq 2^k$，即 $k < \log_{2}{n}$。

**长链剖分**的性质有：

> 根到任意节点轻边的个数**不会超过** $\sqrt{2n}$。

证明：设节点 $u$ 的深度为 $dep_{u}$，父节点为 $u'$，若连接该两点的边为轻边，则 $siz_{u'} \geq siz_{u} + dep_{u} + 1$。若为重边，则 $siz_{u'} \geq siz_{u} + 1$，若该节点到根节点的路径上有 $k$ 条轻边，则树的大小满足关系 $n \geq 1 + \sum_{x=2}^{k}x = \frac{x(x+1)}{2}$，即 $x\leq \sqrt{2n}$。

> 任意点的 $k$ 级祖先所在的长链长度**大于等于** $k$。

证明：采用反证法，若长链长度小于 $k$，则经过该点长度等于（或大于） $k$ 的方案一定更优，与假设矛盾。

## 重链剖分的应用

### 树上启发式合并

对于树上统计的问题，单纯的树形 DP 可能会有空间上的限制，这个时候我们可以不妨采取先统计，再记录的策略，从而节省空间复杂度。此时又可以用启发式合并的思想优化时间复杂度。

树上启发式合并的基本思路如下：

1.  遍历 u 的轻子树，此时数组一定是空的，计算答案，计算完后清空数组。
2. 遍历 u 的重子树，计算答案，并记录数组。
3. 记录 u 的轻子树。

由于重链剖分有着“根节点到树上任意节点的轻边数不超过 $\log{n}$ 条”的性质，而每个节点被遍历的次数又等于它到根节点路径上的轻边数 $+1$，所以可以证明，总时间复杂度为 $O(n \log{n})$。

有关题目，见[树上启发式合并](/solutions/graph/dsu-on-tree)。

